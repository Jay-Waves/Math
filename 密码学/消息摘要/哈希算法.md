# 哈希算法

## 消息认证

我们在进行安全通信的过程中，有许多需要关注的问题。比如说：

-   完整性(integrity)

    如何使接收者确认消息没有被篡改

-   真实性(authenticity)

    如何使接收者确认消息发送自期待的发送者

-   不可否认性(non-repudiation)

    接收者如何能使第三方相信消息发送自期待的发送者。

    与完整性和真实性不同，不可否认性的客体是第三方。这涉及到的是，第三方并不相信接收者，但接收者如何拿出证据使第三方相信消息来自期待的发送者。

这三个问题在密码学中被称作消息认证(Message Authentication)问题。

我们首先解决第一个问题：如何确认消息没有被篡改。也就是，确定消息的完整性。

## 定义

在讨论哈希函数之前，我们需要充分讨论一下目前需要完成的目标：接收者如何确认消息没有被篡改。如果一个算法要实现这个目标，那么这个算法必然是接收我们要传递的消息$m$，并产生一个输出$h$。发送者利用这个算法，将消息$m$以及输出$h$都发送给接收者，而接收者再次利用这个算法处理收到的消息$m'$，通过对比输出$h'$与发送者发送的输出$h$，判断消息$m$是否得到篡改。那么，这一算法最重要的一点是什么呢？显然是尽量避免两个不同的消息$m_1\neq m_2$,
其通过这个算法产生的输出$h_1$和$h_2$相同。如果产生这种情况，我们则称该算法拥有一个**碰撞**。更进一步地，从抵抗攻击的角度来看，这种算法应该使敌手在截获消息经过该算法的输出$h$以后，不能或者难以生成一个篡改的消息$m'$,
使得其经过该算法的输出$h'=h$.
在最理想的状态下，实现这一目标最好的方法就是，从$h$中敌手无法获得任何有关$m$的信息。

根据以上的讨论，这个算法$H(x)$需要满足的性质有：

-   可以适用于任意长度的消息$x$

-   算法的输出$H(x)$是固定长的

-   由输入$x$求得输出$H(x)$的过程较容易，可用硬件和软件实现

-   由输出$H(x)$反求得输入$x$的过程是不可行的，或者是难以计算的

-   给定$x$, 难以求得$y$, 使得$H(x)=H(y)$. 这一点被称作**弱碰撞抵抗**

-   难以求得任何一对$({x, y}$, 使得$H(x)=H(y)$.
    这一点被称作**强碰撞抵抗**

对于第二点，即算法的输出是固定长的。这是由于上述讨论中我们提到，从输出中敌手无法获得输入的任何信息，这里甚至包括输入的消息的长度。不仅如此，在实际操作中，由于"由输入求得输出的过程较容易"这一要求，如果输出是固定长的，那么程序中内存分配等问题就相对较容易。因此，现在通行的算法的输出都是固定长度的。同时，我们也应该了解到，这个"固定长"的长度一般是小于消息的长度的。

用于确认消息没有篡改的算法被称为哈希函数(Hash fucntion).
又称为散列函数。其接受一个消息作为输入，产生的输出被称为该消息的摘要(digest).

一个优秀的哈希函数，应该能做到，对于输入消息的任何一点修改，都会导致输出的巨大改变。下面展示一个例子：

如图是东南大学的校徽，我们对其左上角第一个像素进行篡改。

<figure>
<img src="chapters/chapter_5/MD5_unchanged.jpg" style="width:10em" />
<img src="chapters/chapter_5/MD5_changed.jpg" style="width:10em" />
<figcaption>篡改后的消息</figcaption>
</figure>

我们利用MD5哈希算法求其摘要：

-   未篡改的原消息

    `d3f83ad3cee8eb1c407955509b9f08a0`

-   篡改后的消息

    `d5a15358b5c875e89600b0b53510f5c7`

由此可见，即使对原消息进行一丝一毫的修改，都会产生摘要值的巨大改变。

除了上述功能之外，由于其输出的长度是固定的，因此，哈希函数还有一个重要的用途：当我们要处理的数据很大时，将其通过哈希函数，压缩成较小的数据，则更好处理。

## 应用

在安全通信中，一般较少会直接用到哈希函数，其通常会与之后提到的MAC技术等相结合使用。但是，在一些特定的情况下，哈希函数也是最好的选择。

我们思考几个场景：

第一，由于某个文件过大，所以传递过程缓慢。但是，在截止日期之前，发送者一定要让接收者了解到该文件已经完成，并且接收者在实际收到文件后，需要确认其最后一次修改是在截止日期前。这个情况虽然少见，但也是确实存在的，比如说数学建模比赛，最后的论文可以在截止日期后提交。解决这一问题的方法就是发送者先对文件求一个哈希，将得到的摘要值发给接收者。等文件真正发送给接收者后，接收者再对文件求哈希，如果两个摘要值相等，就说明在截止日期前文件已经完成修改。

第二，在聊天软件中传输文件。现在的机制一般是发送者将发送的文件上传到聊天软件的服务器中，接收者从服务器中下载。那么，为了节省服务器资源，聊天软件设计者一般会在发送者上传文件的时候，对文件求哈希。将摘要值与服务器中已有的文件作比较，如果相同则无需再次上传，接收者可以直接下载对应的文件。

下面，我们将具体介绍哈希函数的实现方法

## Merkle-Damgård结构

在密码学中，许多哈希函数都基于一个类似的结构------Merkle-Damgård结构。首先，我们先介绍一下该结构的两个主要部分。

### 服从MD结构的填充函数

对于正整数$b$来说，如果将所有长度为$b$的整数倍的二进制串构成的集合记作$B$,
将所有长度小于$2^b$的二进制串构成的集合记作$U$.
同时，对于长度为$b$的整数倍的二进制串$M$，将其从头开始分割为长度均为$b$的二进制子串，那么称每个子串为$M$的一个块。

那么对于非空集合$D\subset U$, 以及函数$\mathrm{Pad}:D\to B$,
称满足以下条件的函数$\mathrm{Pad}$为一个相对于$b$的服从MD结构的填充函数：

-   对于任意$M\in D$, $M$是二进制串$\mathrm{Pad}({M}$的前缀

-   对于任意$M_1, M_2\in D$,
    如果$M_1$和$M_2$的长度相同，那么$\mathrm{Pad}({M_1}$和$\mathrm{Pad}({M_2}$的长度相同

-   对于任意$M_1, M_2\in D$, 如果$M_1$和$M_2$的长度不同,
    那么$\mathrm{Pad}({M_1}$和$\mathrm{Pad}({M_2}$的最后一个块不同

对于任意正整数$b$,
我们可以轻易地构造出服从MD结构的填充函数：对于长度为$k$的二进制串$M$,
如果$k\bmod b\neq b-1$, 那么将二进制串$k$后不停地填充$0$,
直到新串的长度模$b$为$b-1$.
然后，将最初串$M$的长度$k$的二进制表示的最后一位填充在最后，形成一个长度为$b$的整数倍的串。可以轻松地证明，这种填充方法，是服从MD结构的。

在上述构造方法中，我们提到，在新串的末尾填充最初串的长度，这一方法被称为Merkle-Damgård强化。

### 单向压缩函数

所谓单向压缩函数，其类似于输入是固定长度的哈希函数。对于单向压缩函数$h$,
其接受两个参数，一个为长度为$b$的二进制串，一个为长度为$v$的二进制串，并输出一个长度为$b$的二进制串。这可以看成一个输入长度为$b+v$,
输出长度为$b$的哈希函数。类似于哈希函数，单向压缩函数也有碰撞抵抗等要求。

利用单向压缩函数，我们可以把设计接收为任意长度的哈希算法归结到设计接收为固定长度的单向压缩函数上来。那么，单向压缩函数又可以怎么设计呢？

而在现行的哈希算法中，单向压缩函数通常利用一个分组密码，使用Davies-Meyer结构构造。具体来说，如果单向压缩函数$h(x, y)$接受长度为$b$比特的$x$和长度为$v$比特的$y$,
输出长度为$b$比特。那么，我们可以使用一个密钥长度为$v$比特，输入长度为$b$比特，输出长度为$b$比特的分组密码加密算法$\E{k}{m}$.
Davies-Meyer结构就是 $$h({x, y}=\E{y}{x}\oplus x$$

利用Davies-Meyer结构，我们又可以把设计单向压缩函数归结到设计一个抵抗碰撞的分组密码上来。

### 算法

要实现服从Merkle-Damgård结构的输出为$b$比特的哈希函数$H$，需要两个正整数$b, v$.
一个相对于$v$的使用了Merkle-Damgård强化的服从MD结构的填充函数$\mathrm{Pad}$,
一个接受参数为分别为长度为$b$和$v$的二进制串的单向压缩函数$h$,
以及一个长度为$b$的初始值$\mathrm{IV}$.

那么，Merkle-Damgård结构的算法为：

1.  将输入的二进制串$M$用$\mathrm{Pad}$函数填充为长度为$nb$比特的二进制串$M'=\mathrm{Pad}({M}$

2.  将$M'$从头开始分割为$n$个长度为$b$比特的子串$M_1, M_2, \ldots, M_n$

3.  对于每个子串$M_i$, 计算$H_i=h({M_i, H_{i-1}}$,
    其中$H_0=\mathrm{IV}$

4.  $H$的输出即为$M_n$

同时，Merkle和Damgård分别独立证明出来，如果单向压缩函数$h$能抵抗碰撞，那么$H$也能抵抗碰撞。

接下来，介绍两个基于Merkle-Damgård结构的哈希算法：MD5和SHA-1

## MD5
[MD5](消息摘要/MD5.md)

## SHA256
[SHA256](消息摘要/SHA256.md)