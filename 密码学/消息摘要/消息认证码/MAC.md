#KeyPoints

# MAC

**定义: 消息认证码, MAC (message authentication code), 是一种消息认证技术, 是指消息被一密钥控制的公开函数作用后产生的, 用作认证符的, 固定长度的数值. 也被称为密码校验和.**  

消息认证包括*消息完整性认证*以及*信源身份认证*. 防御伪装和篡改行为.  
$MAC=C_{K}(M)$. M为输入消息, C为MAC函数, K为*共享密钥*, MAC为消息认证码. 使用时和原消息, 身份认证符一起发送.

MAC **优势和特点**:  
- 普通消息摘要只能保证完整性, 而MAC还能认证消息来源
- [公私钥体系](../../公钥密码/RSA/RSA-签名.md)有**不可抵赖性**; 而MAC双方都有密钥, 都可以伪造消息. MAC计算速度更快, 但不适合大规模分发.
- MAC可以任意长

### MAC 实现方式

- 基于[消息摘要](../消息摘要.md), 比如 [HMAC](HMAC.md) / [KMAC](KMAC.md) / [UMAC](UMAC.md)
- 基于分组密码, 比如  [CMAC](CMAC.md) / [CBC-MAC](CBC-MAC.md) / PMAC
- 基于伪随函数

### MAC 安全性要求

1. **抗第二原像攻击**  
指敌手在不知道密钥K情况下, 伪造一个有相同MAC值的消息 $M'$在计算上不可行.
1. $C_{k}(M)$在值域中分布均匀, 阻止 *基于选择明文的穷举攻击*  
分布均匀, 指随机选消息 $(M, M')$, $Pr[C_{K}(M)=C_{K}(M')]=2^{-n}$. 这样保证, 敌手可以选择明文攻击时, [需平均穷举 $2^{n-1}$次](../生日攻击.md)
1. 认证算法对消息某部分不应比其他部分更弱  
$M'=f(M)$, 比如对M局部插入几比特, 保证 $Pr[C_{K}(M)=C_{K}(M')]=2^{-n}$

### MAC 认证加密

通过MAC,
我们可以实现确定消息的完整性，和确定消息源头的真实性。但是，MAC做不到的却是提供保密性。因此，在实际的安全通信过程中，需要我们同时确保保密性、完整性与真实性。因此，在实际应用中，往往使用的是加密算法与MAC算法结合的方式。这种方式，称为认证加密(Authenticated
encryption).

常见的认证加密方式有三种：先加密再MAC、加密同时MAC、先MAC再加密。

接下来假定由$A$向$B$发送消息$M$, 使用的加密算法为$\E{K}{m}$,
MAC算法为$C_K(m)$. 加密密钥为$K_1$, MAC密钥为$K_2$.
加密密钥和MAC密钥不一定不同，这基于不同的认证加密模式。

#### 先加密再MAC

先加密再MAC(Encrypt-then-MAC, EtM),
指的是先对明文加密，然后根据得到的密文生成MAC,
密文和他的MAC一起发送。即：
$$A\to B: \E{K_1}{M}, C_{K_2}(\E{K_1){m}}$$

这一方法是现在最常用的方法。

#### 加密同时MAC

加密同时MAC(Encrypt-and-MAC, E&M), 指的是基于明文生成MAC,
并且明文在没有MAC的情况下被加密。明文的MAC和密文一起发送。即：
$$A\to B:\E{K_1}{M}, C_{K_2}(M)$$

#### 先MAC再加密

先MAC再加密(MAC-then-Encrypt, MtE), 指的是基于明文生成MAC,
然后将明文和MAC一起加密以基于两者生成密文，密文被发送。即：
$$A\to B:\E{K_1}{M\parallel C_{K_2}(M)}$$

#### 认证加密模式

由于E&M, MtE均有安全上的隐患，所以现在最常用的认证加密方法就是EtM.
但是，EtM只是规定了认证加密的方式，对具体的加密算法和MAC算法并没有规定。因此，许多具体规定了加密算法与MAC算法的认证加密模式就出现了，如OCB,
CCM, EAX, GCM等。


## 参考
> 北航网安密码学课件22  
> [HMAC算法及其应用 - 知乎](https://zhuanlan.zhihu.com/p/136590049)  
> [现代密码学简介](https://github.com/Evian-Zhang/Introduction-to-modern-cryptography)