CMAC是NSIT推荐的基于分组加密算法的MAC算法。

假设要传递的消息为$M$, 密钥为$K$, 分组密码加密算法为$\E{k}{m}$,
其分组长度为$b$比特。

CMAC分为两个步骤：生成子密钥与输出标签。

#### 生成子密钥

对于密钥$K$, 采用下面的算法将其生成为两个长度为$b$比特的子密钥$K_1, K_2$

1.  计算$b$位二进制数$K_0=\E{K}{0}$

2.  记$B_0$为$K_0$表示成二进制数时的最高位（第$b$位）。

    如果$B_0=0$, 则$K_1=K_0\ll 1$,
    其中$x\ll 1$表示将二进制串$x$左移一个比特；

    如果$B_0=1$, 则$K_1=(K_0\ll 1)\oplus C$, 其中
    $$C=\begin{dcases}(1B)_{16}&b=64\\(87)_{16}&b=128\\(425)_{16}&b=256\end{dcases}$$

3.  记$B_1$为$K_1$表示成二进制数时的最高位。

    如果$B_1=0$, 则$K_2=K_1\ll 1$.

    如果$B_1=1$, 则$K_2=(K_1\ll 1)\oplus C$

#### 输出标签

CMAC采用如下算法产生$b$比特的标签：

1.  将$M$从头开始分为$n$个子串$m_1, m_2, \ldots, m_n$.
    其中$m_1, m_2,\ldots, m_{n-1}$的长度均为$b$比特，$m_n$的长度不大于$b$比特。

2.  如果$m_n$的长度是$b$比特，那么$m_n'=K_1\oplus m_n$.

    如果$m_n$的长度小于$b$比特，那么先在其后补一位'1',
    然后一直补'0'直到其长度达到$b$比特的二进制串$m_n''$,
    然后$m_n'=K_2\oplus m_n''$.

3.  采用如下公式加密： $$\begin{aligned}
        &O_1=\E{K}{m_1}\\
        &O_{i}=\E{K}{O_{i-1}\oplus m_{i}},\quad i=2, 3,\ldots, n\\
        &O_n=\E{K}{O_{n-1}\oplus m_n'}
        
    \end{aligned}$$

4.  输出

    CMAC的输出为$b$比特二进制串$O_n$